<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@500&display=swap" rel="stylesheet">
    <title>Memhub ‚Äì –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'users/styles.css' %}">
</head>
<script nonce="{{ request.csp_nonce }}">
    const IMAGES_PER_PAGE = 8;
    const memes = JSON.parse('{{ memes_json|escapejs }}');
    const TOTAL_IMAGES = memes.length;
    let currentPage = 0;

    function renderImages() {
        const container = document.getElementById('memGrid');

        // –ï—Å–ª–∏ –º–µ–º–æ–≤ –Ω–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –≤—ã—Ö–æ–¥–∏–º
        if (TOTAL_IMAGES === 0) {
            container.innerHTML = '<p class="empty-message">–í—ã –µ—â—ë –Ω–µ —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏ –Ω–∏ –æ–¥–Ω–æ–≥–æ –º–µ–º–∞</p>';
            document.querySelector('.nav-icon.left').classList.add('disabled');
            document.querySelector('.nav-icon.right').classList.add('disabled');
            return;
        }

        container.innerHTML = '';
        const start = currentPage * IMAGES_PER_PAGE;
        const end = Math.min(start + IMAGES_PER_PAGE, TOTAL_IMAGES);

        for (let i = start; i < end; i++) {
            const meme = memes[i];
            if (!meme || !meme.id || !meme.image_url) continue;

            const link = document.createElement('a');
            link.href = `/users/selected_meme/${memes[i].id}/`;
            link.className = 'mem-item';

            // –∫–∞—Ä—Ç–∏–Ω–∫–∞ –º–µ–º–∞
            const img = document.createElement('img');
            img.src = memes[i]['image_url'];
            img.alt = `–ú–µ–º ${i + 1}`;

            // –∫—Ä–µ—Å—Ç–∏–∫
            const closeBtn = document.createElement('span');
            closeBtn.className = 'delete-btn';
            closeBtn.innerHTML = '&times;';
            closeBtn.addEventListener('click', function(event) {
                event.preventDefault(); // —á—Ç–æ–±—ã –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª –ø–µ—Ä–µ—Ö–æ–¥ –ø–æ —Å—Å—ã–ª–∫–µ
                deleteMeme(memes[i].id);
            });

            const shareBtn = document.createElement('span');
            shareBtn.className = 'share-btn';
            shareBtn.innerHTML = 'üîó'; // –∏–ª–∏ <img src="...">, –µ—Å–ª–∏ –∏–∫–æ–Ω–∫–∞
            shareBtn.title = '–ü–æ–¥–µ–ª–∏—Ç—å—Å—è';
            shareBtn.addEventListener('click', function (event) {
                event.preventDefault();
                shareMeme(memes[i].id);
            });

            // –¥–æ–±–∞–≤–ª—è–µ–º –∫—Ä–µ—Å—Ç–∏–∫ –∏ –∫–∞—Ä—Ç–∏–Ω–∫—É –≤ –±–ª–æ–∫
            link.appendChild(shareBtn);
            link.appendChild(closeBtn);
            link.appendChild(img);
            container.appendChild(link);
        }

        const leftArrow = document.querySelector('.nav-icon.left');
        const rightArrow = document.querySelector('.nav-icon.right');

        if (currentPage > 0) {
            leftArrow.classList.remove('disabled');
        } else {
            leftArrow.classList.add('disabled');
        }

        if (end < TOTAL_IMAGES) {
            rightArrow.classList.remove('disabled');
        } else {
            rightArrow.classList.add('disabled');
        }
    }

    function nextPage() {
        const maxPage = Math.floor((TOTAL_IMAGES - 1) / IMAGES_PER_PAGE);
        if (currentPage < maxPage) {
            currentPage++;
            renderImages();
        }
    }

    function prevPage() {
        if (currentPage > 0) {
            currentPage--;
            renderImages();
        }
    }

    function deleteMeme(id) {
        if (!confirm("–£–¥–∞–ª–∏—Ç—å –º–µ–º?")) return;

        fetch(`/users/delete_meme/${id}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        }).then(response => {
            if (response.ok) {
                // –£–¥–∞–ª—è–µ–º –∏–∑ –º–∞—Å—Å–∏–≤–∞ –∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º
                const index = memes.findIndex(m => m.id === id);
                if (index !== -1) {
                    memes.splice(index, 1);
                    renderImages();
                }
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –º–µ–º–∞');
            }
        });
    }
    
    async function shareMeme(id) {
        try {
            const response = await fetch("/users/api/create-share-link/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ meme_id: id })
            });

            const data = await response.json();
            if (data.success) {
                await navigator.clipboard.writeText(data.share_url);
                alert("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!");
            } else {
                alert("–û—à–∏–±–∫–∞: " + (data.error || "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è"));
            }
        } catch (err) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—Å—ã–ª–∫–∏:", err);
            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—Å—ã–ª–∫–∏");
        }
    }

    window.addEventListener('load', renderImages);
</script>

<body>
    <a href="{% url 'index' %}" class="logo">
        <img src="{% static 'users/memhub_logo.svg' %}" alt="–õ–æ–≥–æ—Ç–∏–ø">
    </a>

    <div class="mem-block">
        <h2>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h2>
        <h3 class="mem-section-title">–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –º–µ–º—ã</h3>

        <div class="mem-container">
            <div class="nav-icon left" onclick="prevPage()">&#10094;</div>
            <div class="mem-grid" id="memGrid"> </div>
            <div class="nav-icon right" onclick="nextPage()">&#10095;</div>
        </div>
    </div>

    <img src="{% static 'users/cat_lupa.png' %}" alt="" class="bottom-left">
    <img src="{% static 'users/tapaem_homyaka.png' %}" alt="" class="top-right">
</body>
</html>


