<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memhub – Главная</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'users/main_styles.css' %}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@500&display=swap" rel="stylesheet">
</head>
<body>

    <!-- Шапка -->
    <header class="header">
        <img src="{% static 'users/header_bg.png' %}" alt="Фон шапки" class="header-bg">
        <div class="header-content">
            <a href="{% url 'index' %}">
                <img src="{% static 'users/memhub_logo.svg' %}" alt="Логотип" class="header-logo">
            </a>
            <span class="header-title">– сервис для поиска и генерации мемов</span>
        </div>

        {% if user.is_authenticated %}
            <a href="{% url 'users:profile' %}" class="profile-icon">
                <img src="{% static 'users/profile_icon.svg' %}" alt="Профиль">
            </a>
        {% else %}
            <a href="{% url 'login' %}" class="header-login-btn">Вход</a>
        {% endif %}
    </header>

    <!-- Серая линия-разделитель -->
    <div class="divider"></div>

    <!-- Основной контент -->
    <div class="main-content-wrapper">
        <main class="main-content">

            <!-- Кнопки -->
            <div class="button-row">
                <button class="main-btn">Создание мема</button>
                <button class="main-btn">Шаблоны</button>
            </div>

            <!-- Раздел "Как сделать мем" -->
            <div class="howto-section">
                <p class="howto-title">Как сделать мем</p>
                <div class="howto-gallery">
                    <div class="howto-item"><img src="{% static 'users/placeholder_pic.png' %}" alt=""></div>
                    <div class="howto-item"><img src="{% static 'users/placeholder_pic.png' %}" alt=""></div>
                    <div class="howto-item"><img src="{% static 'users/placeholder_pic.png' %}" alt=""></div>
                </div>
            </div>

            <!-- Зона загрузки -->
            <div class="upload-wrapper">
                <div class="upload-frame">
                    <div class="upload-inner">
                        <p class="upload-title">Перетащите изображение сюда</p>
                        <p class="upload-subtitle">Или нажмите, чтобы выбрать изображение</p>
                        <input type="file" id="fileInput" accept="image/*" style="display:none">
                        <div id="preview"></div>
                        <button type="button" class="upload-btn" id="customBtn">Выбрать файл</button>
                        <p class="upload-note">Максимальный размер файла 25MB</p>
                        <img src="{% static 'users/upload_icon.svg' %}" alt="Иконка загрузки" class="upload-icon">
                    </div>
                    <div class="upload-icons">
                        <div class="upload-icons-left">
                            <img src="{% static 'users/add_pic_icon.svg' %}" alt="" id="addImageBtn">
                            <img src="{% static 'users/add_text_icon.svg' %}" alt="" id="addTextBtn">
                        </div>
                        <div class="upload-icons-right">
                            <img src="{% static 'users/telegram_icon.svg' %}" alt="">
                            <img src="{% static 'users/download_icon.svg' %}" alt="">
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        const addImageBtn = document.getElementById('addImageBtn');
        const addTextBtn = document.getElementById('addTextBtn');
        const uploadFrame = document.querySelector('.upload-inner');
    
        function makeDraggable(el) {
            let offsetX = 0, offsetY = 0, isDragging = false;

            el.addEventListener('mousedown', (e) => {
                isDragging = true;
                offsetX = e.clientX - el.offsetLeft;
                offsetY = e.clientY - el.offsetTop;
                el.style.zIndex = 1000;
            });

            document.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    const parent = uploadFrame.getBoundingClientRect();
                    const elemRect = el.getBoundingClientRect();

                    let newLeft = e.clientX - offsetX;
                    let newTop = e.clientY - offsetY;

                    // Ограничение по левому и верхнему краю
                    if (newLeft < 0) newLeft = 0;
                    if (newTop < 0) newTop = 0;

                    // Ограничение по правому и нижнему краю
                    const maxLeft = parent.width - elemRect.width;
                    const maxTop = parent.height - elemRect.height;
                    if (newLeft > maxLeft) newLeft = maxLeft;
                    if (newTop > maxTop) newTop = maxTop;

                    el.style.left = newLeft + 'px';
                    el.style.top = newTop + 'px';
                }
            });

            document.addEventListener('mouseup', () => {
                isDragging = false;
            });

            el.style.position = 'absolute';
            el.style.cursor = 'move';
        }
        
        function makeResizable(el) {
            const resizer = document.createElement('div');
            resizer.style.width = '15px';
            resizer.style.height = '15px';
            resizer.style.background = '#ff9800';
            resizer.style.position = 'absolute';
            resizer.style.right = '0';
            resizer.style.bottom = '0';
            resizer.style.cursor = 'se-resize';
            resizer.style.borderRadius = '3px';
            el.appendChild(resizer);

            resizer.addEventListener('mousedown', (e) => {
                e.preventDefault();
                e.stopPropagation(); // Чтобы не начиналось перетаскивание

                const startX = e.clientX;
                const startY = e.clientY;
                const startWidth = parseInt(document.defaultView.getComputedStyle(el).width, 10);
                const startHeight = parseInt(document.defaultView.getComputedStyle(el).height, 10);

                function doDrag(e) {
                    el.style.width = startWidth + e.clientX - startX + 'px';
                    el.style.height = startHeight + e.clientY - startY + 'px';
                }

                function stopDrag() {
                    document.removeEventListener('mousemove', doDrag);
                    document.removeEventListener('mouseup', stopDrag);
                }

                document.addEventListener('mousemove', doDrag);
                document.addEventListener('mouseup', stopDrag);
            });
        }

        // Добавление текста
        addTextBtn.addEventListener('click', () => {
            const textEl = document.createElement('div');
            textEl.textContent = 'Ваш текст';
            textEl.contentEditable = true;
            textEl.style.color = 'white';
            textEl.style.fontSize = '20px';
            textEl.style.fontWeight = 'bold';
            textEl.style.padding = '4px 8px';
            textEl.style.background = 'rgba(0, 0, 0, 0.6)';
            textEl.style.borderRadius = '4px';
    
            uploadFrame.appendChild(textEl);
            makeDraggable(textEl);
        });
    
        // Добавление изображения
        addImageBtn.addEventListener('click', () => {
            const container = document.createElement('div');
            container.style.position = 'absolute';
            container.style.left = '100px';
            container.style.top = '100px';
            container.style.width = '120px';
            container.style.height = '120px';

            const imgEl = document.createElement('img');
            imgEl.src = '{% static "users/placeholder_pic.png" %}';
            imgEl.style.width = '100%';
            imgEl.style.height = '100%';
            imgEl.style.borderRadius = '8px';
            imgEl.style.pointerEvents = 'none'; // Чтобы не мешал drag/resize
            imgEl.style.userSelect = 'none';

            container.appendChild(imgEl);
            uploadFrame.appendChild(container);

            makeDraggable(container);
            makeResizable(container);
        });
    </script>
    
    <script>
        const fileInput = document.getElementById('fileInput');
        const customBtn = document.getElementById('customBtn');
        const preview = document.getElementById('preview');
    
        // Элементы, которые нужно скрыть после загрузки
        const uploadTitle = document.querySelector('.upload-title');
        const uploadSubtitle = document.querySelector('.upload-subtitle');
        const uploadNote = document.querySelector('.upload-note');
        const uploadIcon = document.querySelector('.upload-icon');
    
        customBtn.addEventListener('click', () => {
            fileInput.click(); // открытие проводника
        });
    
        fileInput.addEventListener('change', () => {
            const file = fileInput.files[0];
            if (file && file.type.startsWith('image/')) {
                // Скрываем лишнее
                uploadTitle.style.display = 'none';
                uploadSubtitle.style.display = 'none';
                uploadNote.style.display = 'none';
                customBtn.style.display = 'none';
                uploadIcon.style.display = 'none';
    
                // Показываем превью
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.innerHTML = ''; // очистка
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.style.maxWidth = '100%';
                    img.style.marginTop = '15px';
                    img.style.borderRadius = '12px';
                    preview.appendChild(img);
                };
                reader.readAsDataURL(file);
            } else {
                preview.innerHTML = '<p style="color: red;">Пожалуйста, выберите изображение.</p>';
            }
        });
    </script>

</body>
</html>
