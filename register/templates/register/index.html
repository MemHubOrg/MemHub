<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memhub ‚Äì –ì–ª–∞–≤–Ω–∞—è</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'register/main_styles.css' %}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@500&display=swap" rel="stylesheet">
</head>
<body>

    <!-- –®–∞–ø–∫–∞ -->
    <header class="header">
        <img src="{% static 'register/header_bg.png' %}" alt="–§–æ–Ω —à–∞–ø–∫–∏" class="header-bg">
        <div class="header-content">
            <a href="{% url 'index' %}">
                <img src="{% static 'register/memhub_logo.svg' %}" alt="–õ–æ–≥–æ—Ç–∏–ø" class="header-logo">
            </a>
            <span class="header-title">‚Äì —Å–µ—Ä–≤–∏—Å –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –º–µ–º–æ–≤</span>
        </div>

        {% if user.is_authenticated %}
            <a href="{% url 'users:profile' %}" class="profile-icon">
                <img src="{% static 'register/profile_icon.svg' %}" alt="–ü—Ä–æ—Ñ–∏–ª—å">
            </a>
        {% else %}
            <a href="{% url 'login' %}" class="header-login-btn">–í—Ö–æ–¥</a>
        {% endif %}
    </header>

    <!-- –°–µ—Ä–∞—è –ª–∏–Ω–∏—è-—Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å -->
    <div class="divider"></div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <div class="main-content-wrapper">
        <main class="main-content">

            <!-- –ö–Ω–æ–ø–∫–∏ -->
            <div class="button-row">
                <button id="btn-create" class="main-btn active-btn" onclick="switchSection('create')">–°–æ–∑–¥–∞–Ω–∏–µ –º–µ–º–∞</button>
                <button id="btn-templates" class="main-btn" onclick="switchSection('templates')">–®–∞–±–ª–æ–Ω—ã</button>
            </div>

            <!-- –†–∞–∑–¥–µ–ª "–ö–∞–∫ —Å–¥–µ–ª–∞—Ç—å –º–µ–º" -->
            <div class="howto-section">
                <p class="howto-title">–ö–∞–∫ —Å–¥–µ–ª–∞—Ç—å –º–µ–º</p>
                <div class="howto-gallery">
                    <div class="howto-item"><img src="{% static 'register/first_instr.png' %}" alt=""></div>
                    <div class="howto-item"><img src="{% static 'register/second_instr.png' %}" alt=""></div>
                    <div class="howto-item"><img src="{% static 'register/third_instr.png' %}" alt=""></div>
                </div>
            </div>

            <!-- –†–∞–∑–¥–µ–ª: –°–æ–∑–¥–∞–Ω–∏–µ –º–µ–º–∞ -->
            <div id="section-create" class="section-create">
            <!-- –ó–æ–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∏ -->
                <div class="upload-wrapper">
                    <div class="upload-frame">
                        <div class="upload-inner">
                            <p class="upload-title">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—é–¥–∞</p>
                            <p class="upload-subtitle">–ò–ª–∏ –Ω–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</p>
                            <input type="file" id="fileInput" accept="image/*" style="display:none">
                            <div id="preview"></div>
                            <button type="button" class="upload-btn" id="customBtn">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</button>
                            <p class="upload-note">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ 25MB</p>
                            <img src="{% static 'register/upload_icon.svg' %}" alt="–ò–∫–æ–Ω–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏"
                                class="upload-icon">
                        </div>
                        <div class="upload-icons">
                            <div class="upload-icons-left">
                                <img src="{% static 'register/add_pic_icon.svg' %}" alt="" id="addImageBtn">
                                <img src="{% static 'register/add_text_icon.svg' %}" alt="" id="addTextBtn">
                                <input type="file" id="image-input" accept="image/*" style="display: none;" />
                            </div>
                            <div class="upload-icons-right">
                                {% if user.is_authenticated %}
                                    <a href="#" id="saveMeme" class="text-button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–µ–º</a>
                                {% endif %}
                                {% if user.is_authenticated %}
                                    <img src="{% static 'users/telegram_icon.svg' %}" alt="" id="sendToTelegram">
                                {% endif %}
                                <img src="{% static 'register/download_icon.svg' %}" alt="–°–∫–∞—á–∞—Ç—å"
                                    id="downloadBtn">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –†–∞–∑–¥–µ–ª: –®–∞–±–ª–æ–Ω—ã -->
            <div id="section-templates" class="section-templates" style="display: none;">
                <div class="howto-section">
                    <p class="howto-title">–®–∞–±–ª–æ–Ω—ã</p>

                    <div class="template-search-row">
                        <input type="text" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º" class="template-search-input">
                        <button class="template-search-btn">üîç</button>
                        <button class="template-clear-btn">‚úñ</button>
                    </div>

                    <div class="template-grid">
                        {% for template in templates %}
                        <div class="template-item">
                            <img src="{{ template.image_url }}" alt="">
                            <button class="template-action-btn"
                                    onclick="selectTemplate('{{ template.image_url }}')">
                                –°–¥–µ–ª–∞—Ç—å –º–µ–º
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–æ–≤ -->
    <script>
        console.log('–°–∫—Ä–∏–ø—Ç –∑–∞–≥—Ä—É–∂–µ–Ω');
        function switchSection(section) {
            // –°–∫—Ä—ã–≤–∞–µ–º –æ–±–∞ —Ä–∞–∑–¥–µ–ª–∞
            console.log('–§—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—â–µ–Ω–∞');
            console.log('–ù–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞:', section);
            document.getElementById('section-create').style.display = 'none';
            document.getElementById('section-templates').style.display = 'none';

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ä–∞–∑–¥–µ–ª
            if (section === 'create') {
                document.getElementById('section-create').style.display = 'block';
            } else if (section === 'templates') {
                document.getElementById('section-templates').style.display = 'block';
            }

            // –ú–µ–Ω—è–µ–º —Ü–≤–µ—Ç –∫–Ω–æ–ø–æ–∫
            document.getElementById('btn-create').style.backgroundColor = section === 'templates' ? '#ED9E1D' : '#999';
            document.getElementById('btn-templates').style.backgroundColor = section === 'create' ? '#ED9E1D' : '#999';
        }
    </script>

    <!-- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ–º–∞ –≤ –ø—Ä–æ—Ñ–∏–ª—å -->
    <script>
        const saveMeme= document.getElementById('saveMeme');
        if (saveMeme) {
            saveMeme.addEventListener('click', saveMemeToProfile);
        }
    
        function saveMemeToProfile() {
            const target = document.querySelector('.upload-inner');
            if (!target) {
                console.error('–≠–ª–µ–º–µ–Ω—Ç .upload-inner –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }
    
            const toHide = target.querySelectorAll('div[style*="position: absolute"] > div');
            const hiddenElements = [];
            toHide.forEach(el => {
                hiddenElements.push({ element: el, display: el.style.display });
                el.style.display = 'none';
            });
    
            const containers = target.querySelectorAll('div[style*="position: absolute"]');
            const containerStyles = [];
            containers.forEach(el => {
                containerStyles.push({
                    element: el,
                    border: el.style.border,
                    boxShadow: el.style.boxShadow,
                    transform: el.style.transform
                });
                el.style.border = 'none';
                el.style.boxShadow = 'none';
            });
    
            setTimeout(() => {
                html2canvas(target, {
                    useCORS: true,
                    backgroundColor: null,
                    scale: 2
                }).then(canvas => {
                    canvas.toBlob((blob) => {
                        const formData = new FormData();
                        formData.append('file', blob, 'meme.png');
    
                        fetch('/save_meme_to_profile/', {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': '{{ csrf_token }}'
                            },
                            body: formData
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                alert('–ú–µ–º —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –ø—Ä–æ—Ñ–∏–ª—å!');
                            } else {
                                alert('–û—à–∏–±–∫–∞: ' + (data.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è'));
                            }
                        })
                        .catch(error => console.error('Error:', error));
                    });
                });
    
                hiddenElements.forEach(({ element, display }) => {
                    element.style.display = display;
                });
                containerStyles.forEach(({ element, border, boxShadow }) => {
                    element.style.border = border;
                    element.style.boxShadow = boxShadow;
                });
            }, 50);
        };
    </script>

    <!-- –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ –¢–ì –º–µ–º–∞ -->
    <script>
        const sendToTelegram = document.getElementById('sendToTelegram');
        if (sendToTelegram) {
            sendToTelegram.addEventListener('click', sendToTelegramfunc);
        }
    
        function sendToTelegramfunc() {
            const target = document.querySelector('.upload-inner');
            if (!target) {
                console.error('–≠–ª–µ–º–µ–Ω—Ç .upload-inner –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }
    
            const toHide = target.querySelectorAll('div[style*="position: absolute"] > div');
            const hiddenElements = [];
            toHide.forEach(el => {
                hiddenElements.push({ element: el, display: el.style.display });
                el.style.display = 'none';
            });
    
            const containers = target.querySelectorAll('div[style*="position: absolute"]');
            const containerStyles = [];
            containers.forEach(el => {
                containerStyles.push({
                    element: el,
                    border: el.style.border,
                    boxShadow: el.style.boxShadow,
                    transform: el.style.transform
                });
                el.style.border = 'none';
                el.style.boxShadow = 'none';
            });
    
            setTimeout(() => {
                html2canvas(target, {
                    useCORS: true,
                    backgroundColor: null,
                    scale: 2
                }).then(canvas => {
                    canvas.toBlob((blob) => {
                        const formData = new FormData();
                        formData.append('file', blob, 'meme.png');
    
                        fetch('/send_meme_to_telegram/', {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': '{{ csrf_token }}'
                            },
                            body: formData
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                alert('–ú–µ–º —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram!');
                            } else {
                                alert('–û—à–∏–±–∫–∞: ' + (data.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è'));
                            }
                        })
                        .catch(error => console.error('Error:', error));
                    });
                });
    
                hiddenElements.forEach(({ element, display }) => {
                    element.style.display = display;
                });
                containerStyles.forEach(({ element, border, boxShadow }) => {
                    element.style.border = border;
                    element.style.boxShadow = boxShadow;
                });
            }, 50);
        };
    </script>

    <!-- C–∫–∞—á–∏–≤–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –∫–∞–∫ PNG -->
    <script 
        src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js">
    </script>
     
    <script>
        const downloadBtn = document.getElementById('downloadBtn');
        if (downloadBtn) {
            downloadBtn.addEventListener('click', downloadImage);
        }

        function downloadImage() {
            const target = document.querySelector('.upload-inner');
            if (!target) {
                console.error('–≠–ª–µ–º–µ–Ω—Ç .upload-inner –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }
    
            // –°–∫—Ä—ã—Ç—å —É–ø—Ä–∞–≤–ª—è—é—â–∏–µ –∫–Ω–æ–ø–∫–∏
            const toHide = target.querySelectorAll('div[style*="position: absolute"] > div');
            const hiddenElements = [];
            toHide.forEach(el => {
                hiddenElements.push({ element: el, display: el.style.display });
                el.style.display = 'none';
            });
    
            // –£–±—Ä–∞—Ç—å —Ä–∞–º–∫–∏ –∏ —Ç–µ–Ω–∏
            const containers = target.querySelectorAll('div[style*="position: absolute"]');
            const containerStyles = [];
            containers.forEach(el => {
                containerStyles.push({
                    element: el,
                    border: el.style.border,
                    boxShadow: el.style.boxShadow,
                    transform: el.style.transform
                });
                el.style.border = 'none';
                el.style.boxShadow = 'none';
            });
    
            requestAnimationFrame(() => {
                html2canvas(target, {
                    useCORS: true,
                    backgroundColor: null,
                    scale: 2
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = 'meme.png';
                    link.href = canvas.toDataURL('image/png');
                    link.click();
    
                    // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∏–ª–∏
                    hiddenElements.forEach(({ element, display }) => {
                        element.style.display = display;
                    });
                    containerStyles.forEach(({ element, border, boxShadow, transform }) => {
                        element.style.border = border;
                        element.style.boxShadow = boxShadow;
                        element.style.transform = transform;
                    });
                });
            });
        };
    </script>

    <!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞/–∫–∞—Ä—Ç–∏–Ω–æ–∫ + –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –º–µ–Ω—è—Ç—å —Ä–∞–∑–º–µ—Ä/–≤—Ä–∞—â–∞—Ç—å –∏—Ö -->
    <script>
        const addImageBtn = document.getElementById('addImageBtn');
        const addTextBtn = document.getElementById('addTextBtn');
        const uploadFrame = document.querySelector('.upload-inner');

        function addDeleteButton(el) {
            const delBtn = document.createElement('div');
            delBtn.textContent = '√ó';
            delBtn.style.position = 'absolute';
            delBtn.style.top = '-10px';
            delBtn.style.right = '-10px';
            delBtn.style.background = '#f44336';
            delBtn.style.color = 'white';
            delBtn.style.width = '20px';
            delBtn.style.height = '20px';
            delBtn.style.borderRadius = '50%';
            delBtn.style.display = 'flex';
            delBtn.style.justifyContent = 'center';
            delBtn.style.alignItems = 'center';
            delBtn.style.cursor = 'pointer';
            delBtn.style.fontWeight = 'bold';
            delBtn.style.zIndex = 1001;

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º contentEditable = false, —á—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∞ –Ω–µ –≤—ã–¥–µ–ª—è–ª–∞—Å—å
            delBtn.setAttribute('contenteditable', 'false');
            delBtn.setAttribute('unselectable', 'on');
            delBtn.style.userSelect = 'none';

            delBtn.addEventListener('click', (e) => {
                e.stopPropagation(); // —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞–ª drag
                el.remove();
            });

            el.appendChild(delBtn);
        }

        function addRotateButton(el) {
            const rotateBtn = document.createElement('div');
            rotateBtn.textContent = '‚ü≥';
            rotateBtn.style.position = 'absolute';
            rotateBtn.style.top = '-10px';
            rotateBtn.style.left = '-10px';
            rotateBtn.style.background = '#2196f3';
            rotateBtn.style.color = 'white';
            rotateBtn.style.width = '20px';
            rotateBtn.style.height = '20px';
            rotateBtn.style.borderRadius = '50%';
            rotateBtn.style.display = 'flex';
            rotateBtn.style.justifyContent = 'center';
            rotateBtn.style.alignItems = 'center';
            rotateBtn.style.cursor = 'grab';
            rotateBtn.style.fontWeight = 'bold';
            rotateBtn.style.zIndex = 1001;

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º contentEditable = false, —á—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∞ –Ω–µ –≤—ã–¥–µ–ª—è–ª–∞—Å—å
            rotateBtn.setAttribute('contenteditable', 'false');
            rotateBtn.setAttribute('unselectable', 'on');
            rotateBtn.style.userSelect = 'none';

            el.appendChild(rotateBtn);

            let isRotating = false;
            let initialAngle = 0;

            rotateBtn.addEventListener('mousedown', (e) => {
                e.preventDefault();
                e.stopPropagation();
                isRotating = true;
                rotateBtn.style.cursor = 'grabbing';

                const rect = el.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;

                const startAngle = Math.atan2(e.clientY - centerY, e.clientX - centerX);
                initialAngle = parseFloat(el.getAttribute('data-rotation') || '0');

                function rotate(eMove) {
                    if (!isRotating) return;

                    const currentAngle = Math.atan2(eMove.clientY - centerY, eMove.clientX - centerX);
                    const delta = currentAngle - startAngle;
                    const degrees = initialAngle + delta * (180 / Math.PI);

                    el.style.transform = `rotate(${degrees}deg)`;
                    el.setAttribute('data-rotation', degrees);
                }

                function stopRotate() {
                    isRotating = false;
                    rotateBtn.style.cursor = 'grab';
                    document.removeEventListener('mousemove', rotate);
                    document.removeEventListener('mouseup', stopRotate);
                }

                document.addEventListener('mousemove', rotate);
                document.addEventListener('mouseup', stopRotate);
            });
        }
    
        function makeDraggable(el) {
            let offsetX = 0, offsetY = 0, isDragging = false;

            el.addEventListener('mousedown', (e) => {
                isDragging = true;
                offsetX = e.clientX - el.offsetLeft;
                offsetY = e.clientY - el.offsetTop;
                el.style.zIndex = 1000;
            });

            document.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    const parent = uploadFrame.getBoundingClientRect();
                    const elemRect = el.getBoundingClientRect();

                    let newLeft = e.clientX - offsetX;
                    let newTop = e.clientY - offsetY;

                    // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ –ª–µ–≤–æ–º—É –∏ –≤–µ—Ä—Ö–Ω–µ–º—É –∫—Ä–∞—é
                    if (newLeft < 0) newLeft = 0;
                    if (newTop < 0) newTop = 0;

                    // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ –ø—Ä–∞–≤–æ–º—É –∏ –Ω–∏–∂–Ω–µ–º—É –∫—Ä–∞—é
                    const maxLeft = parent.width - elemRect.width;
                    const maxTop = parent.height - elemRect.height;
                    if (newLeft > maxLeft) newLeft = maxLeft;
                    if (newTop > maxTop) newTop = maxTop;

                    el.style.left = newLeft + 'px';
                    el.style.top = newTop + 'px';
                }
            });

            document.addEventListener('mouseup', () => {
                isDragging = false;
            });

            el.style.position = 'absolute';
            el.style.cursor = 'move';
        }
        
        function makeResizable(el) {
            const resizer = document.createElement('div');
            resizer.style.width = '15px';
            resizer.style.height = '15px';
            resizer.style.background = '#ff9800';
            resizer.style.position = 'absolute';
            resizer.style.right = '0';
            resizer.style.bottom = '0';
            resizer.style.cursor = 'se-resize';
            resizer.style.borderRadius = '3px';
            el.appendChild(resizer);

            resizer.addEventListener('mousedown', (e) => {
                e.preventDefault();
                e.stopPropagation(); // –ß—Ç–æ–±—ã –Ω–µ –º–µ—à–∞–ª drag

                const startX = e.clientX;
                const startY = e.clientY;
                const startWidth = parseInt(window.getComputedStyle(el).width, 10);
                const startHeight = parseInt(window.getComputedStyle(el).height, 10);
                const startLeft = el.offsetLeft;
                const startTop = el.offsetTop;

                function doDrag(e) {
                    const parentRect = uploadFrame.getBoundingClientRect();

                    let newWidth = startWidth + e.clientX - startX;
                    let newHeight = startHeight + e.clientY - startY;

                    // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —à–∏—Ä–∏–Ω—ã –∏ –≤—ã—Å–æ—Ç—ã —Ç–∞–∫, —á—Ç–æ–±—ã —ç–ª–µ–º–µ–Ω—Ç –Ω–µ –≤—ã—à–µ–ª –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã uploadFrame
                    const maxWidth = parentRect.width - startLeft;
                    const maxHeight = parentRect.height - startTop;

                    if (newWidth > maxWidth) newWidth = maxWidth;
                    if (newHeight > maxHeight) newHeight = maxHeight;

                    el.style.width = newWidth + 'px';
                    el.style.height = newHeight + 'px';
                }

                function stopDrag() {
                    document.removeEventListener('mousemove', doDrag);
                    document.removeEventListener('mouseup', stopDrag);
                }

                document.addEventListener('mousemove', doDrag);
                document.addEventListener('mouseup', stopDrag);
            });
        }

        addTextBtn.addEventListener('click', () => {
            const textEl = document.createElement('div');
            textEl.textContent = '–í–∞—à —Ç–µ–∫—Å—Ç';
            textEl.contentEditable = true;
            textEl.style.color = 'white';
            textEl.style.fontSize = '20px';
            textEl.style.fontWeight = 'bold';
            textEl.style.padding = '4px 8px';
            textEl.style.background = 'rgba(0, 0, 0, 0.6)';
            textEl.style.borderRadius = '4px';

            textEl.style.position = 'absolute';
            textEl.style.left = '100px';
            textEl.style.top = '100px';

            // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —É–¥–∞–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç –ø—É—Å—Ç–æ–π
            textEl.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace' && textEl.textContent.length == 2) {
                    e.preventDefault();
                }
            });

            uploadFrame.appendChild(textEl);
            makeDraggable(textEl);
            addDeleteButton(textEl);
            addRotateButton(textEl);
        });

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏
        document.getElementById('addImageBtn').addEventListener('click', () => {
            document.getElementById('image-input').click();
        });

        document.getElementById('image-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.');
                return;
            }

            const reader = new FileReader();
            reader.onload = (event) => {
                const container = document.createElement('div');
                container.style.position = 'absolute';
                container.style.left = '100px';
                container.style.top = '100px';
                container.style.width = '150px';
                container.style.height = '150px';

                const imgEl = document.createElement('img');
                imgEl.src = event.target.result;
                imgEl.style.width = '100%';
                imgEl.style.height = '100%';
                imgEl.style.borderRadius = '8px';
                imgEl.style.pointerEvents = 'none';
                imgEl.style.userSelect = 'none';

                container.appendChild(imgEl);
                uploadFrame.appendChild(container);

                makeDraggable(container);
                makeResizable(container);
                addDeleteButton(container);
                addRotateButton(container);
            };

            reader.readAsDataURL(file);
        });
    </script>
    
    <script>
        const fileInput = document.getElementById('fileInput');
        const customBtn = document.getElementById('customBtn');
        const preview = document.getElementById('preview');
    
        // –≠–ª–µ–º–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ —Å–∫—Ä—ã—Ç—å –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
        const uploadTitle = document.querySelector('.upload-title');
        const uploadSubtitle = document.querySelector('.upload-subtitle');
        const uploadNote = document.querySelector('.upload-note');
        const uploadIcon = document.querySelector('.upload-icon');
    
        customBtn.addEventListener('click', () => {
            fileInput.click(); // –æ—Ç–∫—Ä—ã—Ç–∏–µ –ø—Ä–æ–≤–æ–¥–Ω–∏–∫–∞
        });
    
        fileInput.addEventListener('change', () => {
            const file = fileInput.files[0];
            if (file && file.type.startsWith('image/')) {
                // –°–∫—Ä—ã–≤–∞–µ–º –ª–∏—à–Ω–µ–µ
                uploadTitle.style.display = 'none';
                uploadSubtitle.style.display = 'none';
                uploadNote.style.display = 'none';
                customBtn.style.display = 'none';
                uploadIcon.style.display = 'none';
    
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.innerHTML = ''; // –æ—á–∏—Å—Ç–∫–∞
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.style.maxWidth = '100%';
                    img.style.marginTop = '15px';
                    img.style.borderRadius = '12px';
                    preview.appendChild(img);
                };
                reader.readAsDataURL(file);
            } else {
                preview.innerHTML = '<p style="color: red;">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.</p>';
            }
        });
    </script>

    <!-- –ü–µ—Ä–µ–Ω–æ—Å —à–∞–±–ª–æ–Ω–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –º–µ–º–∞ -->
     <script>
        document.addEventListener("DOMContentLoaded", async function () {
            const imageUrl = sessionStorage.getItem("selected_template");
            if (imageUrl) {
                sessionStorage.removeItem("selected_template");

                switchSection('create');

                try {
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –∏ —Å–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç File
                    const response = await fetch(imageUrl);
                    const blob = await response.blob();
                    const file = new File([blob], "template.jpg", { type: blob.type });

                    // –°–æ–∑–¥–∞–µ–º DataTransfer –∏ –ø–æ–º–µ—â–∞–µ–º —Ç—É–¥–∞ —Ñ–∞–π–ª
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);

                    // –ù–∞–∑–Ω–∞—á–∞–µ–º "–≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π" —Ñ–∞–π–ª –≤ input
                    const input = document.getElementById("fileInput");
                    input.files = dataTransfer.files;

                    // –í—Ä—É—á–Ω—É—é –≤—ã–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
                    const event = new Event("change", { bubbles: true });
                    input.dispatchEvent(event);
                } catch (err) {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–µ —à–∞–±–ª–æ–Ω–∞:", err);
                }
            }
        });
    </script>
    <!-- <script>
        document.addEventListener("DOMContentLoaded", function () {
            const imageUrl = sessionStorage.getItem("selected_template");
            if (imageUrl) {
                sessionStorage.removeItem("selected_template");

                switchSection('create');

                const preview = document.getElementById("preview");
                preview.innerHTML = "";

                const img = document.createElement("img");
                img.src = imageUrl;
                img.alt = "–®–∞–±–ª–æ–Ω";
                img.style.maxWidth = "100%";
                img.style.marginTop = "15px";
                img.style.borderRadius = "12px";
                preview.appendChild(img);

                // –°–∫—Ä—ã—Ç—å —É–ø—Ä–∞–≤–ª—è—é—â–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã, –∫–∞–∫ –ø—Ä–∏ –æ–±—ã—á–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–µ
                const uploadTitle = document.querySelector('.upload-title');
                const uploadSubtitle = document.querySelector('.upload-subtitle');
                const uploadNote = document.querySelector('.upload-note');
                const customBtn = document.getElementById('customBtn');
                const uploadIcon = document.querySelector('.upload-icon');

                if (uploadTitle) uploadTitle.style.display = 'none';
                if (uploadSubtitle) uploadSubtitle.style.display = 'none';
                if (uploadNote) uploadNote.style.display = 'none';
                if (customBtn) customBtn.style.display = 'none';
                if (uploadIcon) uploadIcon.style.display = 'none';
            }
        });
    </script> -->

    <script>
    function selectTemplate(imageUrl) {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—É—Ç—å –≤ sessionStorage
        sessionStorage.setItem("selected_template", imageUrl);
        // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –≥–ª–∞–≤–Ω—É—é
        window.location.href = "/";
    }
    </script>

    <!--–ü–æ–∏—Å–∫ –ø–æ —Ç–µ–≥–∞–º-->
    <script>
    document.querySelector('.template-search-btn').addEventListener('click', () => {
        const input = document.querySelector('.template-search-input');
        const query = input.value.trim();

        fetch(`/api/templates/?tag=${encodeURIComponent(query)}`)
            .then(res => res.json())
            .then(data => {
                const grid = document.querySelector('.template-grid');
                grid.innerHTML = "";

                data.forEach(template => {
                    const item = document.createElement('div');
                    item.classList.add('template-item');

                    item.innerHTML = `
                        <img src="${template.imageUrl}" alt="">
                        <button class="template-action-btn" onclick="selectTemplate('${template.imageUrl}')">
                            –°–¥–µ–ª–∞—Ç—å –º–µ–º
                        </button>
                    `;
                    grid.appendChild(item);
                });
            });
    });
    </script>
</body>
</html>
